generator client {
    provider = "prisma-client"
    output   = "../src/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

enum Role {
    USER
    ADMIN
}

enum OrderStatus {
    PENDING
    PAID
    CANCELLED
}

model User {
    id               String          @id @default(uuid())
    name             String
    email            String          @unique
    password         String?
    role             Role            @default(USER)
    locale           String          @default("en")
    googleId         String?         @unique
    stripeCustomerId String?         @unique
    createdAt        DateTime        @default(now())
    updatedAt        DateTime        @updatedAt
    sessions         Session[]
    tokens           Token[]
    orders           Order[]
    cartItems        Cart[]
    reviews          Review[]
    purchasedBooks   PurchasedBook[]
}

model Session {
    id        String   @id @default(uuid())
    ip        String?
    browser   String?
    os        String?
    userId    String
    expiresAt DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Token {
    id        String   @id @default(uuid())
    token     String
    userId    String
    expiresAt DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Book {
    id          String          @id @default(uuid())
    gutenbergId Int             @unique
    title       String
    cover       String
    file        String
    authors     String[]
    summaries   String[]
    subjects    String[]
    popularity  Int
    languages   String[]
    price       Float
    createdAt   DateTime        @default(now())
    updatedAt   DateTime        @updatedAt
    reviews     Review[]
    orderItems  OrderItem[]
    cartItems   Cart[]
    purchased   PurchasedBook[]

    @@index([title])
}

model Cart {
    id       String   @id @default(uuid())
    userId   String
    bookId   String
    quantity Int      @default(1)
    addedAt  DateTime @default(now())
    user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    book     Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

    @@unique([userId, bookId])
}

model Review {
    id         String   @id @default(uuid())
    userId     String
    bookId     String
    rating     Int
    title      String?
    content    String
    isApproved Boolean  @default(false)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    book       Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)

    @@unique([userId, bookId])
}

model Order {
    id              String          @id @default(uuid())
    status          OrderStatus     @default(PENDING)
    subtotal        Int
    tax             Int
    total           Int
    stripeSessionId String?         @unique
    userId          String
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    user            User            @relation(fields: [userId], references: [id])
    items           OrderItem[]
    purchasedBooks  PurchasedBook[]
}

model OrderItem {
    id        String   @id @default(uuid())
    orderId   String
    bookId    String
    quantity  Int
    price     Int
    createdAt DateTime @default(now())
    order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
    book      Book     @relation(fields: [bookId], references: [id])
}

model PurchasedBook {
    id        String   @id @default(uuid())
    userId    String
    bookId    String
    orderId   String
    createdAt DateTime @default(now())
    user      User     @relation(fields: [userId], references: [id])
    book      Book     @relation(fields: [bookId], references: [id])
    order     Order    @relation(fields: [orderId], references: [id])

    @@unique([userId, bookId])
}
